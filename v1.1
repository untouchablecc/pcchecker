import os
import requests
import sys
from pathlib import Path

WEBHOOKS = {
    'process_traces': 'https://canary.discord.com/api/webhooks/1279148419193114694/l4pr5CEMMlD4LDsZ9_plYFSfTgWCVvWqXCN9Gri6XVq8bRL55GZtgNZXGOU1TrY34SCV',
}

def send_webhook(webhook_url, content):
    try:
        response = requests.post(webhook_url, json={'content': content})
        response.raise_for_status()
    except requests.exceptions.RequestException as e:
        print(f"Failed to send webhook: {e}")

def scan_directory(directory, trace_file):
    results = []
    for root, dirs, files in os.walk(directory):
        for file in files:
            file_path = os.path.join(root, file)
            # Example trace detection logic
            if 'example' in file.lower():  # Replace with actual detection logic
                results.append(f"Found trace: {file_path}")
    # Write results to the file
    with open(trace_file, 'a') as f:
        for result in results:
            f.write(result + '\n')
    return results

def main():
    if len(sys.argv) < 2:
        print("No option provided.")
        return

    option = sys.argv[1]
    if option != '--scan-directory':
        print("Invalid option.")
        return

    output_folder = os.path.join(Path.home(), 'AppData', 'MyPythonScript')
    Path(output_folder).mkdir(parents=True, exist_ok=True)
    results_log_path = os.path.join(output_folder, 'results.txt')
    error_log_path = os.path.join(output_folder, 'error_log.txt')

    directories_to_scan = [
        "C:\\",  # Root directory
        "C:\\Users\\%USERNAME%\\AppData\\Local",  # AppData Local
        "C:\\Users\\%USERNAME%\\AppData\\Roaming"  # AppData Roaming
        # Add more directories as needed
    ]
    
    try:
        for directory in directories_to_scan:
            print(f"Scanning through folder {directory}")
            results = scan_directory(directory, results_log_path)
            if results:
                print(f"Found traces in {directory} - See results.txt for details.")
                send_webhook(WEBHOOKS['process_traces'], "\n".join(results))
            else:
                print(f"Folder {directory} is clear.")
    except Exception as e:
        with open(error_log_path, 'a') as f:
            f.write(f"Error: {e}\n")
        print(f"Script execution completed. Check the error log for details.")

if __name__ == "__main__":
    main()
